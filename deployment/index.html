<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>FCEUX</title>
    <style>
      html, body {
        margin: 0;
        border: 0px none;
        padding: none;
        float: none;
        font-family:"Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 12px;
        font-style: italic;
        font-weight: 900;
        color: #EEE;
        background-color: #111;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      div.emscripten { text-align: center; }      
      canvas.emscripten {
        position: relative;
        border: 0px none;
        width: 1024px;
        height: 896px;
        width: auto;
        height: 100%;
      }
      #centerContainer {
        text-align: center;
        position: absolute;
        top: 50%;
        left: 50%;
        border: 0px none;
        width: 256px;
        height: 256px;
        margin-left: -128px;
        margin-top: -128px;
      }
      #loader {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 88px;
        height: 88px;
        margin-left: -44px;
        margin-top: -44px;
        background-color: #111;
      }
      #loaderSpinner {
        height: 36px;
        width: 36px;
        margin: 0;
        display: inline-block;

        -webkit-animation: rotation .7s linear infinite;
        -moz-animation: rotation .7s linear infinite;
        -o-animation: rotation .7s linear infinite;
        animation: rotation 0.7s linear infinite;

        border-left: 24px solid #FCFCFC;
        border-right: 24px solid #FCFCFC;
        border-bottom: 24px solid #FCFCFC;
        border-top: 24px solid #111;
        
        border-radius: 100%;
        background-color: #111;
      }
      @-webkit-keyframes rotation {
        from {-webkit-transform: rotate(0deg);}
        to {-webkit-transform: rotate(360deg);}
      }
      @-moz-keyframes rotation {
        from {-moz-transform: rotate(0deg);}
        to {-moz-transform: rotate(360deg);}
      }
      @-o-keyframes rotation {
        from {-o-transform: rotate(0deg);}
        to {-o-transform: rotate(360deg);}
      }
      @keyframes rotation {
        from {transform: rotate(0deg);}
        to {transform: rotate(360deg);}
      }
      #controlsTab {
        position: absolute;
        top: 0;
        left: -280px;
        width: 300px;
        height: 100%;
        transition: left 500ms;
      }
      #controlsToggleLabel {
        position: absolute;
        top: 50%;
        right: 0px;
        margin-top: -64px;
        margin-right: 0px;
        border-style: solid;
        border-color: transparent white transparent white;
        opacity: 0.3;
        border-width: 64px 0px 64px 16px;
        width: 0px;
        height: 0px;
        -webkit-transform: scale(.9999); 
        -moz-transform: scale(.9999); 
        -o-transform: scale(.9999); 
        transform: scale(.9999);
      }
      #controlsToggle:checked + #controlsTab #controlsToggleLabel {
        border-width: 64px 16px 64px 0px;
      }
      #controlsToggle:checked ~ #controlsTab {
        left: 0px;
      }
      #controlsContainer {
        position: absolute;
        text-align: right;
        bottom: 0px;
        left: 0px;
        width: 280px;
        height: 100%;
        overflow: hidden;
      }
      #controlsSliders input {
	margin: 0;
	padding: 0;
        right: 0px;
        width: 150px;
      }
      #stackTab {
        position: absolute;
        top: 0;
        right: -414px;
        width: 434px;
        height: 100%;
        transition: right 500ms;
      }
      #stackToggleLabel {
        position: absolute;
        top: 50%;
        margin-top: -64px;
        margin-right: 4px;
        border-style: solid;
        border-color: transparent white transparent white;
        opacity: 0.3;
        border-width: 64px 16px 64px 0px;
        width: 0px;
        height: 0px;
        -webkit-transform: scale(.9999); 
        -moz-transform: scale(.9999); 
        -o-transform: scale(.9999); 
        transform: scale(.9999);
      }
      #stackToggle:checked + #stackTab #stackToggleLabel {
        border-width: 64px 0px 64px 16px;
      }
      #stackToggle:checked ~ #stackTab {
        right: 0px;
      }
      #stackContainer {
        position: absolute;
        bottom: 0px;
        right: 0px;
        width: 414px;
        height: 100%;
        overflow-x: hidden;
        overflow-y: scroll;
      }
      #stack {
        display: table;
        width: 414px;
        height: 100%;
        border-collapse: collapse;
        //border: 1px solid white;
      }
      .label {
        position: relative;
        text-align: center;
        vertical-align: middle;
        width: 172px;
        height: 18px;
        line-height: 17px;
        //background-color: #f8f;
      }
      .labelContainer {
        position: relative;
        overflow: hidden;
        left: 64px;
        top: 1px;
        width: 172px;
        height: 18px;
        clip: rect(0px, 172px, 18px 0px);
        //background-color: #88f;
      }
      .cartDelete {
        position: relative;
        width: 25px;
        height: 25px;
        top: -15px;
        left: 372px;
        //background-color: #f88;
      }
      .cart {
        position: relative;
        display: table-row;
        width: 397px;
        height: 55px;
        vertical-align: bottom;
        background-image: url('img/top4.png');
        background-repeat: no-repeat;
        background-position: 0px 0px;
        //border: 1px solid white;
      }

    </style>
    <script type="text/javascript">
      // NOTE: do not change values!
      var BRIGHTNESS = 0;
      var CONTRAST = 1;
      var COLOR = 2;
      var GAMMA = 3;
      var GLOW = 4;
      var SHARPNESS = 5;
      var RGBPPU = 6;
      var CRT_ENABLED = 7;
      var SCANLINES = 8;
      var CONVERGENCE = 9;
      var NOISE = 10;
      var FCEM = {
        games : [],
        stackToggleElem : null,
        controlsToggleElem : null,
        showStack : function(show) {
          FCEM.stackToggleElem.checked = show;
        },
        showControls : function(show) {
          FCEM.controlsToggleElem.checked = show;
        },
        onInitialSyncFromIDB : function(er) {
          assert(!er);
          try {
            FS.mkdir('/fceux/sav');
          } catch (e) {
          }
          try {
            FS.mkdir('/fceux/rom');
          } catch (e) {
          }
//          var savs = findFiles('/default/'); 
//          savs.forEach(function(x) { console.log('!!!! sav: ' + x); });
          FCEM.updateGames();
          FCEM.updateStack();
          FCEM.showStack(true);
          FCEM.setControl = Module.cwrap('FCEM_setControl', null, ['number', 'number']);
          // Write savegame and synchronize IDBFS in intervals.
          setInterval(Module.cwrap('FCEM_onSaveGameInterval'), 1000);
        },
        onDeleteGameSyncFromIDB : function(er) {
          assert(!er);
          FCEM.updateGames();
          FCEM.updateStack();
        },
        onSyncToIDB : function(er) {
          assert(!er);
        },
        onDOMLoaded : function() {
          FCEM.stackToggleElem = document.getElementById('stackToggle');
          FCEM.controlsToggleElem = document.getElementById('controlsToggle');
          FCEM.showStack(false);
          FCEM.showControls(false);
        },
        startGame : function(path) {
          Module.romName = path;
          Module.romReload = 1;
        },
        updateGames : function() {
          var games = [];
          var addGamesIn = function(path, deletable) {
            var files = findFiles(path); 
            files.forEach(function(filename) {
              var split = PATH.splitPath(filename);
              var label = split[2].slice(0, -split[3].length).toUpperCase();
              var offset = calcGameOffset();
              games.push({label:label, path:filename, offset:offset, deletable:deletable});
            });
          };

          addGamesIn('/default/', false);
          addGamesIn('/fceux/rom/', true);

          // sort in alphabetic order and assign as new games list
          games.sort(function(a, b) {
            return a < b ? -1 : a > b ? 1 : 0;
          });
          FCEM.games = games;
        },
        updateStack : function() {
          var games = FCEM.games;
          var stackContainer = document.getElementById("stackContainer");
          var scrollPos = stackContainer.scrollTop;
          var list = document.getElementById("stack");
          var proto = document.getElementById("cartProto");
        
          while (list.firstChild != list.lastChild) {
            list.removeChild(list.lastChild);
          }
        
          for (var i = 0; i < games.length; i++) {
            var item = games[i];
            var el = proto.cloneNode(true);
        
            el.id = i;
            el.className = 'cart';
            el.style.backgroundPosition = item.offset + 'px 0px';
            list.appendChild(el);
        
            var label = el.firstChild.firstChild;
            label.style.fontSize = '12px';
            label.style.lineHeight = '16px';
            label.innerHTML = item.label;
            if (label.scrollHeight > 18) {
              label.style.fontSize = '8px';
              label.style.lineHeight = '9px';
            }

            if (!item.deletable) {
              el.lastChild.hidden = true;
            }
          }
        
          stackContainer.scrollTop = scrollPos;
        }
      };
      window.onbeforeunload = function (ev) {
        var msg = 'Do you want to close the FCEUX emulator and the current game? Unsaved game data will be lost.';
        (ev || window.event).returnValue = msg; 
        return msg;
      };
    </script>
  </head>
  <body>

    <canvas class="emscripten" id="canvas" hidden="true" oncontextmenu="event.preventDefault()"></canvas>

    <div id="centerContainer">
      <div id="loader">
        <div id="loaderSpinner"></div>
      </div>
    </div>

    <script type='text/javascript'>
      var centerContainerElem = document.getElementById('centerContainer');

      var Module = {
        preRun: [function() {
          // Mount IndexedDB file system (IDBFS) to /fceux.
          FS.mkdir('/fceux');
          FS.mount(IDBFS, {}, '/fceux');
          FS.syncfs(true, FCEM.onInitialSyncFromIDB);
        }],
        postRun: [],
        print: function() {
          text = Array.prototype.slice.call(arguments).join(' ');
          console.log(text);
        },
        printErr: function(text) {
          text = Array.prototype.slice.call(arguments).join(' ');
          console.error(text);
        },
        canvas: (function() {
          var canvasElement = document.getElementById('canvas');

          // As a default initial behavior, pop up an alert when webgl context is lost. To make your
          // application robust, you may want to override this behavior before shipping!
          // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
          canvasElement.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

          return canvasElement;
        })(),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Date.now() < 30) return;
          if (m) {
            text = m[1];
          } else {
            if (!text) {
              Module.canvas.hidden = false;
              centerContainerElem.hidden = true;
            }
          }
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module.setStatus('Loading...');
      window.onerror = function(event) {
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };
    </script>
    <script async type="text/javascript" src="fceux.js"></script>
    <script type="text/javascript">
      function dragHandler(text) {
        return function(ev) {
          ev.stopPropagation();
          ev.preventDefault();
        };
      }
      function dropHandler(ev) {
        ev.stopPropagation();
        ev.preventDefault();
        var f = ev.dataTransfer.files[0];
        if (f && confirm('want to add game: ' + f.name + '?')) {
          var r = new FileReader();
          r.onload = function(e) { 
            var opts = {encoding:'binary'};
            var path = PATH.join2('/fceux/rom/', f.name);
            FS.writeFile(path, new Uint8Array(e.target.result), opts);
            FCEM.updateGames();
            FCEM.updateStack();
            FCEM.startGame(path);
          }
          r.readAsArrayBuffer(f);
        }
      }
      document.addEventListener('dragenter', dragHandler('enter'), false);
      document.addEventListener('dragleave', dragHandler('leave'), false);
      document.addEventListener('dragover', dragHandler('over'), false);
      document.addEventListener('drop', dropHandler, false);
    </script>
    <script type="text/javascript">
    </script>

    <input id="controlsToggle" type="checkbox" hidden="1" />
    <div id="controlsTab">
        <div id="controlsContainer">
          <div id="controlsSliders">
    <h3>Picture Controls</h3>
    Brightness <input type="range" min="-1" max="1" value="0" step="0.2" oninput="FCEM.setControl(BRIGHTNESS, this.value)" onchange="FCEM.setControl(BRIGHTNESS, this.value)"/><br/>
    Contrast <input type="range" min="-1" max="1" value="0" step="0.2" oninput="FCEM.setControl(CONTRAST, this.value)" onchange="FCEM.setControl(CONTRAST, this.value)"/><br/>
    Color <input type="range" min="-1" max="1" value="0" step="0.2" oninput="FCEM.setControl(COLOR, this.value)" onchange="FCEM.setControl(COLOR, this.value)"/><br/>
    Gamma <input type="range" min="-1" max="1" value="0" step="0.2" oninput="FCEM.setControl(GAMMA, this.value)" onchange="FCEM.setControl(GAMMA, this.value)"/><br/>
    <h3>NTSC Emulation Controls</h3>
    NTSC Emulation <input type="checkbox" checked oninput="FCEM.setControl(RGBPPU, !this.checked)" onchange="FCEM.setControl(RGBPPU, !this.checked)"/><br/>
    Sharpness <input type="range" min="-0.5" max="0.5" value="0.2" step="0.1" oninput="FCEM.setControl(SHARPNESS, this.value)" onchange="FCEM.setControl(SHARPNESS, this.value)"/><br/>
    <h3>TV Emulation Controls</h3>
    TV Emulation <input type="checkbox" checked oninput="FCEM.setControl(CRT_ENABLED, this.checked)" onchange="FCEM.setControl(CRT_ENABLED, this.checked)"/><br/>
    Scanlines <input type="range" min="0" max="1" value="0.1" step="0.1" oninput="FCEM.setControl(SCANLINES, this.value)" onchange="FCEM.setControl(SCANLINES, this.value)"/><br/>
    Glow <input type="range" min="0" max="1" value="0.2" step="0.1" oninput="FCEM.setControl(GLOW, this.value)" onchange="FCEM.setControl(GLOW, this.value)"/><br/>
    Convergence <input type="range" min="0" max="1" value="0.4" step="0.1" oninput="FCEM.setControl(CONVERGENCE, this.value)" onchange="FCEM.setControl(CONVERGENCE, this.value)"/><br/>
    Signal Noise <input type="range" min="0" max="1" value="0.3" step="0.1" oninput="FCEM.setControl(NOISE, this.value)" onchange="FCEM.setControl(NOISE, this.value)"/><br/>
        </div>
    <input type="button" value="Fullscreen" onclick="Module.requestFullScreen(false, false)"/>
<!--    <input type="button" value="Reset" onclick="resetControls()"/>
    <input type="button" value="Hide stack" onclick="FCEM.showStack(false)" />
    <input type="button" value="dump FS" onclick="var f = findFiles('/'); f.forEach(function(x) { console.log('!!!! dump: ' + x); })" /> -->
        </div>
        <label id="controlsToggleLabel" for="controlsToggle"></label>
    </div>

    <div hidden="1">
      <div class="cart" id="cartProto" onclick="return askSelectGame(event, this);"><div class="labelContainer"><div class="label"></div></div><div class="cartDelete" onclick="return askDeleteGame(event, this.parentNode);"></div></div>
    </div>
    <input id="stackToggle" type="checkbox" hidden="1" />
    <div id="stackTab">
        <label id="stackToggleLabel" for="stackToggle"></label>
        <div id="stackContainer"><div id="stack"><div></div></div></div>
    </div>

    <script type="text/javascript">
      var current = 0;

      function calcGameOffset() {
        return (8 * Math.random()) |0;
      }
      
      function askConfirmGame(ev, el, q) {
        var games = FCEM.games;
        ev.stopPropagation();
        ev.preventDefault();
        var idx = current + (el.id |0);
        if ((idx >= 0) && (idx < games.length) && confirm(q + ' ' + games[idx].label + '?')) {
          return idx;
        } else {
          return -1;
        }
      }
      
      function askSelectGame(ev, el) {
        var idx = askConfirmGame(ev, el, 'want to start');
        if (idx != -1) {
          FCEM.startGame(FCEM.games[idx].path);
          setTimeout(function() { FCEM.showStack(false); FCEM.showControls(false); }, 1000);
        }
        return false;
      }
      
      function askDeleteGame(ev, el) {
        var idx = askConfirmGame(ev, el, 'want to delete');
        if (idx != -1) {
          var item = FCEM.games.slice(idx, idx+1)[0];
          FS.unlink(item.path);
          FS.syncfs(FCEM.onDeleteGameSyncFromIDB);
        }
        return false;
      }

      function findFiles(startPath) {
        var entries = [];

        function isRealDir(p) {
          return p !== '.' && p !== '..';
        };
        function toAbsolute(root) {
          return function(p) {
            return PATH.join2(root, p);
          }
        };

        try {
            return FS.readdir(startPath).filter(isRealDir).map(toAbsolute(startPath));
        } catch (e) {
            return [];
        }
// TODO: remove, this is for recursive search
/*
      while (check.length) {
        var path = check.pop();
        var stat;

        try {
          stat = FS.stat(path);
        } catch (e) {
          return [];
        }

        if (FS.isDir(stat.mode)) {
          check.push.apply(check, FS.readdir(path).filter(isRealDir).map(toAbsolute(path)));
        }

        entries.push(path);
      }

      return entries;
*/
    }


      document.addEventListener('DOMContentLoaded', FCEM.onDOMLoaded, false);
    </script>

    <script src="//cdn.webglstats.com/stat.js" defer="defer" async="async"></script>
  </body>
</html>
